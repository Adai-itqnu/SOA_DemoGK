<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>üìö Danh s√°ch s√°ch c√≥ th·ªÉ m∆∞·ª£n</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #e8f0ff, #f4f6f8);
        text-align: center;
        margin: 0;
        padding: 20px;
      }
      h2 {
        color: #333;
        margin-bottom: 10px;
      }
      a.logout {
        display: inline-block;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #dc3545;
        color: white;
        border-radius: 8px;
        text-decoration: none;
      }
      a.logout:hover {
        background: #b92b39;
      }
      table {
        width: 90%;
        margin: 0 auto;
        border-collapse: collapse;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      th {
        background: #007bff;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
      }
      tr:hover {
        background: #f1f7ff;
      }
      button {
        background: #007bff;
        border: none;
        padding: 8px 12px;
        color: white;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        text-align: left;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .modal-content h3 {
        text-align: center;
      }
      .modal-content input,
      .modal-content select {
        width: 100%;
        margin: 8px 0;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      .close {
        float: right;
        font-size: 20px;
        cursor: pointer;
        color: #aaa;
      }
      .close:hover {
        color: #000;
      }

      /* Loading spinner */
      .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #007bff;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <h2>üìñ Xin ch√†o, <span id="username"></span>!</h2>
    <p>Danh s√°ch c√°c s√°ch hi·ªán c√≥ th·ªÉ m∆∞·ª£n</p>
    <a class="logout" href="#" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</a>

    <!-- Loading indicator -->
    <div id="loading" class="loading" style="display: none">
      <div class="spinner"></div>
      <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <table id="bookTable" style="display: none">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th>T√°c gi·∫£</th>
          <th>Th·ªÉ lo·∫°i</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>M∆∞·ª£n</th>
        </tr>
      </thead>
      <tbody>
        <!-- S·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
      </tbody>
    </table>

    <!-- Modal -->
    <div id="borrowModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>üìñ M∆∞·ª£n s√°ch</h3>
        <p id="bookTitle"></p>
        <input type="hidden" id="bookId" />
        <label>S·ªë l∆∞·ª£ng:</label>
        <input type="number" id="quantity" min="1" />
        <label>S·ªë ng√†y m∆∞·ª£n:</label>
        <select id="days">
          <option value="1">1 ng√†y</option>
          <option value="2">2 ng√†y</option>
          <option value="3">3 ng√†y</option>
          <option value="5">5 ng√†y</option>
          <option value="7">7 ng√†y</option>
        </select>
        <button onclick="borrowBook()">‚úÖ X√°c nh·∫≠n m∆∞·ª£n</button>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const username = localStorage.getItem("username");
      document.getElementById("username").textContent = username || "";

      let modal = document.getElementById("borrowModal");
      let currentBookId = null;
      let maxQuantity = 0;

      async function loadBooks() {
        // Show loading
        document.getElementById("loading").style.display = "block";
        document.getElementById("bookTable").style.display = "none";

        try {
          const res = await fetch("/book-api/books", {
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) {
            throw new Error("Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá");
          }

          const books = await res.json();
          const tbody = document.querySelector("#bookTable tbody");
          tbody.innerHTML = "";

          books.forEach((b) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${b.id}</td>
              <td>${b.title}</td>
              <td>${b.author}</td>
              <td>${b.category}</td>
              <td>${b.quantity}</td>
              <td><button onclick="openModal('${b.id}','${b.title}','${b.quantity}')">üìò M∆∞·ª£n</button></td>
            `;
            tbody.appendChild(row);
          });

          // Hide loading and show table
          document.getElementById("loading").style.display = "none";
          document.getElementById("bookTable").style.display = "table";
        } catch (error) {
          document.getElementById("loading").style.display = "none";
          alert(error.message);
          window.location.href = "/auth/login";
        }
      }

      function openModal(id, title, availableQty) {
        currentBookId = id;
        maxQuantity = availableQty;
        document.getElementById("bookTitle").innerText = `üìò ${title}`;
        document.getElementById("quantity").value = 1;
        document.getElementById("quantity").max = availableQty;
        modal.style.display = "flex";
      }

      function closeModal() {
        modal.style.display = "none";
      }

      async function borrowBook() {
        const quantity = parseInt(document.getElementById("quantity").value);
        const days = parseInt(document.getElementById("days").value);

        if (quantity <= 0 || quantity > maxQuantity) {
          alert("‚ùå S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
          return;
        }

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "‚è≥ ƒêang m∆∞·ª£n...";
        btn.disabled = true;

        try {
          const data = { book_id: currentBookId, quantity, days };
          const res = await fetch("/borrow-api/borrow", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify(data),
          });

          if (res.ok) {
            alert("‚úÖ M∆∞·ª£n s√°ch th√†nh c√¥ng!");
            closeModal();
            loadBooks();
          } else {
            const err = await res.json();
            alert("‚ùå L·ªói: " + err.error);
          }
        } catch (error) {
          alert("‚ùå L·ªói: " + error.message);
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }

      function logout() {
        localStorage.clear();
        window.location.href = "/auth/login";
      }

      window.onclick = function (event) {
        if (event.target === modal) closeModal();
      };

      loadBooks();
    </script>
  </body>
</html>
